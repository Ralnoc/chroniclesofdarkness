<?xml version="1.0" encoding="iso-8859-1"?>

<!-- This file is provided under the Open Game License version 1.0a
     For more information on OGL and related issues, see 
       http://www.wizards.com/d20
    
     All producers of work derived from this definition are adviced to
     familiarize themselves with the above license, and to take special
     care in providing the definition of Product Identity (as specified
     by the OGL) in their products.
    
     Copyright 2009 SmiteWorks Ltd.
  -->

<root version="2.0">
  
  <windowclass name="notelist">
    <frame>scrollboxfortabs</frame>
    <placement>
      <size>
        <width>275</width>
        <height>350</height>
      </size>
    </placement>
    <sizelimits>
      <dynamic />
      <minimum>
        <width>200</width>
        <height>290</height>
      </minimum>
    </sizelimits>
    <nodelete />
    <sheetdata>
      <CloseBox>
        <position>-13,5</position>
      </CloseBox>
      <genericcontrol>
        <bounds>16,21,30,177</bounds>
        <icon>title_items</icon>
      </genericcontrol>
      <windowlist name="list">
        <bounds>50,25,-30,-34</bounds>
        <class>notesmall</class>
        <footer>footer_narrow</footer>
        <skipempty/>
        <script file="scripts/notelist.lua" />
      </windowlist>
      <scrollercontrol>
        <bounds>-105,-61,45,27</bounds>
        <target>list</target>
        <button>
          <normal>button_scroller</normal>
          <pressed>button_scroller_down</pressed>
        </button>
      </scrollercontrol>
      <buttoncontrol>
        <bounds>-55,-58,34,25</bounds>
        <icon>
          <normal>button_newwindow</normal>
          <pressed>button_newwindowdown</pressed>
        </icon>
        <class>note</class>
        <script>
          function onButtonPress()
            window.list.addNote();
          end
        </script>
      </buttoncontrol>
      <filter name="filter">
        <bounds>55,-70,-50,20</bounds>
        <target>list</target>
        <trigger>filtertrigger</trigger>
      </filter>
      <filtertrigger name="filtertrigger">
        <bounds>20,-85,21,41</bounds>
        <target>filter</target>
      </filtertrigger>
    </sheetdata>
  </windowclass>

  <windowclass name="notesmall">
    <sizelimits>
      <minimum>
        <height>10</height>
      </minimum>
    </sizelimits>
    <script>
      local initialised = false;
      local publicnode = nil;
      
      function onInit()
        publicnode = getDatabaseNode().createChild("ispublic","number");
        if publicnode then
          publicnode.onUpdate = requestFilter;
        end
        getDatabaseNode().onObserverUpdate = refresh;
        initialised = true;
        refresh();
      end
      
      function requestFilter()
        windowlist.applyFilter();
      end
      
      function onMenuSelection(entry)
        if entry and entry==6 then
          windowlist.deleteNote(self);
          return true;
        end
      end
      
      function refresh()
        local locked = true;
        if not initialised then
          return;
        end
        if not publicnode then
          publicnode = getDatabaseNode().createChild("ispublic","number");
          if publicnode then
            publicnode.onUpdate = requestFilter;
          end
        end
        locked = not getDatabaseNode().isOwner();
        if User.isHost() then
          locked = false;
        end
        --[[ enable/disable menus ]]
        resetMenuItems();
        if not locked then
          registerMenuItem("Delete Note","delete",6);
        end
      end
          
      function filter()
        refresh();
        if not initialised then
          return false;
        end
        if User.isHost() then
          return true;
        end
        if getDatabaseNode().isOwner() then
          return true;
        end
        if publicnode and publicnode.getValue()==1 then
          return true;
        end
        return false;
      end
    </script>
    <sheetdata>
      <windowreferencecontrol name="open">
        <bounds>0,0,20,20</bounds>
        <icon>
          <normal>button_openwindow</normal>
          <pressed>button_emptytarget</pressed>
        </icon>
        <class>note</class>
        <description>
          <field>name</field>
        </description>
      </windowreferencecontrol>
      <stringfield name="name">
        <bounds>25,1,-1,20</bounds>
        <empty>&#171; New Note &#187;</empty>
        <font>sheettext</font>
        <linktarget>open</linktarget>
        <underlineoffset>-3</underlineoffset>
        <nodrag />
        <static/>
        <script>
          hoverontext = false;

          function onHover(oncontrol)
            if not oncontrol then
              setUnderline(false);
              hoverontext = false;
            end
          end

          function onHoverUpdate(x, y)
            if getIndexAt(x, y) &lt; #getValue() then
              setUnderline(true);
              hoverontext = true;
            else
              setUnderline(false);
              hoverontext = false;
            end
          end

          function onClickDown(button, x, y)
            if hoverontext then
              return true;
            else
              return false;
            end
          end

          function onClickRelease(button, x, y)
            if hoverontext then
              window[linktarget[1]].activate();
              return true;
            end
          end

          function onDrag(button, x, y, draginfo)
            if hoverontext then
              draginfo.setType("shortcut");
              draginfo.setShortcutData(window[linktarget[1]].getValue());
              draginfo.setIcon(window[linktarget[1]].icon[1].normal[1])
              return true;
            else
              return false;
            end
          end
        </script>
      </stringfield>
    </sheetdata>
  </windowclass>

  <windowclass name="note_content">
    <script>
      function onInit()
        getDatabaseNode().onObserverUpdate = refresh;
        refresh();
      end
      
      function refresh()
        local locked = true;
        locked = not getDatabaseNode().isOwner();
        if User.isHost() then
          locked = false;
        end
        --[[ set the fields to be read-only for non-owners ]]
        if text then text.setReadOnly(locked) end;
      end
    </script>
    <sheetdata>
      <stringfield name="text">
        <anchored>
          <left>
            <anchor>left</anchor>
            <offset>5</offset>
          </left>
          <right>
            <anchor>right</anchor>
            <offset>-5</offset>
          </right>
          <top>
            <anchor>top</anchor>
          </top>
        </anchored>
        <font>sheettextsmall</font>
        <multilinespacing>15</multilinespacing>
        <empty>Click here to add text.</empty>
        <script>
          function onInit()
            if super and super.onInit then
              super.onInit();
            end
            onValueChanged();
          end
          
          function onValueChanged()
            local value = getValue();
            if super and super.onValueChanged then
              super.onValueChanged();
            end
            if value=="" then
              setFont("chatitalicfont");
            else
              setFont("sheettextsmall");
            end
          end
        </script>
      </stringfield>
    </sheetdata>
  </windowclass>

  <windowclass name="note">
    <frame>storybox</frame>
    <placement>
      <size>
        <width>250</width>
        <height>306</height>
      </size>
    </placement>
    <sizelimits>
      <dynamic />
    </sizelimits>
    <minimize>minimized_note</minimize>
    <nodelete/>
    <playercontrol />
    <tooltip>
      <field>name</field>
    </tooltip>
    <script>
      function onInit()
        local node = getDatabaseNode();
        getDatabaseNode().onObserverUpdate = refresh;
        if node.getChild("newnote") and node.getChild("newnote").getValue()==1 then
          node.getChild("newnote").setValue(0);
        end
        refresh();
      end
      
      function refresh()
        local locked = true;
        locked = not getDatabaseNode().isOwner();
        if User.isHost() then
          locked = false;
        end
        --[[ set the fields to be read-only for non-owners ]]
        if name then name.setReadOnly(locked) end;
        if ispublic then ispublic.setReadOnly(locked) end;
      end
    </script>
    <sheetdata>
      <CloseBox>
        <position>-16,5</position>
      </CloseBox>
      <windowopencontrol>
        <bounds>15,11,20,20</bounds>
        <icon>
          <normal>button_openwindow</normal>
          <pressed>button_emptytarget</pressed>
        </icon>
        <class>note</class>
        <description>
          <field>name</field>
        </description>
      </windowopencontrol>
      <stringfield name="name">
        <bounds>40,13,-30,20</bounds>
        <empty>&#171; New Note &#187;</empty>
        <font>sheettext</font>
      </stringfield>
      <checkbox name="ispublic">
        <anchored>
          <to>name</to>
          <position>belowright</position>
          <offset>9,6</offset>
          <size>
            <width>12</width>
            <height>12</height>
          </size>
        </anchored>
        <stateicons>
          <on>indicator_checkon</on>
          <off>indicator_checkoff</off>
        </stateicons>
      </checkbox>
      <stringcontrol>
        <anchored>
          <to>ispublic</to>
          <position>aboveright</position>
          <offset>16,-12</offset>
        </anchored>
        <font>sheetlabelsmall</font>
        <static>Public note</static>
      </stringcontrol>
      <stringcontrol>
        <anchored>
          <to>name</to>
          <position>belowleft</position>
          <offset>-25,6</offset>
        </anchored>
        <font>sheetlabelsmall</font>
        <static>Owner:</static>
      </stringcontrol>
      <stringfield name="owner">
        <anchored>
          <to>name</to>
          <position>belowleft</position>
          <offset>8,6</offset>
        </anchored>
        <font>sheetlabelsmall</font>
        <empty>None</empty>
        <static/>
      </stringfield>
      <!-- Subwindow -->
      <subwindow name="content">
        <bounds>10,55,-20,-20</bounds>
        <class>note_content</class>
        <activate/>
      </subwindow>
      <scrollercontrol name="content_scroller">
        <anchored>
          <to>content</to>
          <position>insidebottomright</position>
          <offset>-4,-10</offset>
        </anchored>
        <target>content</target>
        <button>
          <normal>button_scroller</normal>
          <pressed>button_scroller_down</pressed>
        </button>
      </scrollercontrol>
    </sheetdata>
  </windowclass>
  
</root>