<?xml version="1.0" encoding="iso-8859-1"?>

<!-- This file is provided under the Open Game License version 1.0a
     For more information on OGL and related issues, see 
       http://www.wizards.com/d20
    
     All producers of work derived from this definition are adviced to
     familiarize themselves with the above license, and to take special
     care in providing the definition of Product Identity (as specified
     by the OGL) in their products.
    
     Copyright 2009 SmiteWorks Ltd.
  -->

<root version="2.2">
  
  <windowclass name="encounter">
    <frame>charsheet</frame>
    <placement>
      <size>
        <width>275</width>
        <height>350</height>
      </size>
    </placement>
    <sizelimits>
      <dynamic />
      <minimum>
        <width>200</width>
        <height>290</height>
      </minimum>
    </sizelimits>
    <nodelete/>
    <minimize>minimized_encounter</minimize>
    <tooltip>
      <field>name</field>
    </tooltip>
    <script>
      function addToTracker()
        if CombatManager then
          CombatManager.addEncounterToTracker(getDatabaseNode());
        end
      end
    </script>
    <sheetdata>
      <CloseBox>
        <position>-6,2</position>
      </CloseBox>
      <!-- NAME -->
      <genericcontrol name="nameframe">
        <bounds>10,20,-10,35</bounds>
        <frame>
          <name>sheetgroup</name>
        </frame>
      </genericcontrol>
      <windowopencontrol>
        <anchored>
          <to>nameframe</to>
          <position>insidetopleft</position>
          <offset>13,8</offset>
          <size>
            <width>20</width>
            <height>20</height>
          </size>
        </anchored>
        <icon>
          <normal>button_openwindow</normal>
          <pressed>button_emptytarget</pressed>
        </icon>
        <class>encounter</class>
        <description>
          <field>name</field>
        </description>
      </windowopencontrol>
      <stringfield name="name">
        <anchored>
          <top>
            <parent>nameframe</parent>
            <anchor>top</anchor>
            <offset>9</offset>
          </top>
          <left>
            <parent>nameframe</parent>
            <anchor>left</anchor>
            <offset>35</offset>
          </left>
          <right>
            <parent>nameframe</parent>
            <anchor>right</anchor>
            <offset>-30</offset>
          </right>
        </anchored>
        <empty>&#171; New Encounter &#187;</empty>
        <font>sheettext</font>
      </stringfield>
      <genericcontrol>
        <anchored>
          <to>name</to>
          <position>righthigh</position>
          <offset>1,-2</offset>
          <size>
            <width>22</width>
            <height>22</height>
          </size>
        </anchored>
        <icon>indicator_ctactive</icon>
        <tooltip>
          <text>Add to combat tracker</text>
        </tooltip>
        <script>
          function onClickDown()
            return true;
          end
          
          function onClickRelease()
            window.addToTracker();
          end
        </script>
      </genericcontrol>
      <!-- Frame -->
      <genericcontrol name="contentframe">
        <bounds>10,54,-10,-13</bounds>
        <frame>
          <name>sheetgroup</name>
          <offset>0,1,0,0</offset>
        </frame>
      </genericcontrol>
      <windowlist name="list">
        <anchored>
          <to>contentframe</to>
          <position>over</position>
          <offset>-10,-10</offset>
        </anchored>
        <datasource>.list</datasource>
        <class>encounter_entry</class>
        <footer>footer_narrow</footer>
        <allowcreate/>
        <allowdelete/>
        <acceptdrop>
          <class>npc</class>
          <field>name</field>
          <field>armor</field>
          <field>defense</field>
          <field>description</field>
          <field>initiative</field>
          <field>size</field>
          <field>speed</field>
          <field>token</field>
          <field>vice</field>
          <field>virtue</field>
        </acceptdrop>
        <script>
          local dropnode = nil;
          
          function onDrop(x,y,draginfo)
            if not User.isHost() then
              return;
            end
            if draginfo.isType("npc") then
              dropnode = draginfo.getDatabaseNode();
            elseif draginfo.isType("shortcut") then
              local class = draginfo.getShortcutData();
              if class=="npc" then
                dropnode = draginfo.getDatabaseNode();
              end
            end
          end
          
          function getDropNode()
            local node = dropnode;
            dropnode = nil;
            return node;
          end
        </script>
      </windowlist>
      <scrollercontrol>
        <anchored>
          <to>list</to>
          <position>insidebottomright</position>
          <offset>0,0</offset>
          <size>
            <width>45</width>
            <height>27</height>
          </size>
        </anchored>
        <target>list</target>
        <button>
          <normal>button_scroller</normal>
          <pressed>button_scroller_down</pressed>
        </button>
      </scrollercontrol>
    </sheetdata>
  </windowclass>

  <windowclass name="encountersmall">
    <sizelimits>
      <minimum>
        <height>10</height>
      </minimum>
    </sizelimits>
    <script>
      function addToTracker()
        if CombatManager then
          CombatManager.addEncounterToTracker(getDatabaseNode());
        end
      end
    </script>
    <sheetdata>
      <windowreferencecontrol name="open">
        <bounds>0,0,20,20</bounds>
        <icon>
          <normal>button_openwindow</normal>
          <pressed>button_emptytarget</pressed>
        </icon>
        <class>encounter</class>
        <description>
          <field>name</field>
        </description>
        <script file="scripts/adventurelistshortcut.lua" />
      </windowreferencecontrol>
      <linkstringfield name="name">
        <bounds>25,1,-30,20</bounds>
        <empty>&#171; New Encounter &#187;</empty>
        <selectioncolor>#90ffffff</selectioncolor>
        <font>sheettext</font>
        <linktarget>open</linktarget>
      </linkstringfield>
      <genericcontrol>
        <anchored>
          <to>name</to>
          <position>righthigh</position>
          <offset>1,-2</offset>
          <size>
            <width>22</width>
            <height>22</height>
          </size>
        </anchored>
        <icon>indicator_ctactive</icon>
        <tooltip>
          <text>Add to combat tracker</text>
        </tooltip>
        <script>
          function onClickDown()
            return true;
          end
          
          function onClickRelease()
            window.addToTracker();
          end
        </script>
      </genericcontrol>
    </sheetdata>
  </windowclass>
  
  <windowclass name="encounterlist">
    <frame>scrollboxfortabs</frame>
    <placement>
      <size>
        <width>275</width>
        <height>350</height>
      </size>
    </placement>
    <sizelimits>
      <dynamic />
      <minimum>
        <width>200</width>
        <height>290</height>
      </minimum>
    </sizelimits>
    <nodelete />
    <sheetdata>
      <CloseBox>
        <position>-13,5</position>
      </CloseBox>
      <genericcontrol>
        <bounds>16,21,30,177</bounds>
        <icon>title_encounters</icon>
      </genericcontrol>
      <windowlist name="list">
        <bounds>50,25,-20,-34</bounds>
        <datasource>.</datasource>
        <class>encountersmall</class>
        <sortfields>name</sortfields>
        <footer>footer_narrow</footer>
        <allowcreate />
        <allowdelete />
        <useallmodules/>
        <script>
          function onSortCompare(w1, w2)
            return w1.name.getValue() &gt; w2.name.getValue();
          end;
          
          function onFilter(w)
            local f = string.lower(window.filter.getValue());
            
            if f == "" then
              return true;
            end
            
            if string.find(string.lower(w.name.getValue()), f, 0, true) then
              return true;
            end
            
            return false;
          end
        </script>
      </windowlist>
      <scrollercontrol>
        <bounds>-105,-61,45,27</bounds>
        <target>list</target>
        <button>
          <normal>button_scroller</normal>
          <pressed>button_scroller_down</pressed>
        </button>
      </scrollercontrol>
      <buttoncontrol>
        <bounds>-55,-58,34,25</bounds>
        <icon>
          <normal>button_newwindow</normal>
          <pressed>button_newwindowdown</pressed>
        </icon>
        <class>encounter</class>
        <script>
          function onButtonPress()
            local node = window.getDatabaseNode();
            if node then
              node = node.createChild();
              if node then
                Interface.openWindow(class[1], node.getNodeName());
              end
            end
          end
        </script>
      </buttoncontrol>
      <categoryselectioncontrol>
        <bounds>24,-39,-24,-1</bounds>
        <targetcontrol>list</targetcontrol>
      </categoryselectioncontrol>

      <filter name="filter">
        <bounds>55,-70,-50,20</bounds>
        <target>list</target>
        <trigger>filtertrigger</trigger>
      </filter>
      <filtertrigger name="filtertrigger">
        <bounds>20,-85,21,41</bounds>
        <target>filter</target>
      </filtertrigger>      
    </sheetdata>
  </windowclass>

  <windowclass name="encounter_entry">
    <sizelimits>
      <minimum>
        <height>25</height>
      </minimum>
    </sizelimits>
    <script>
      function onInit()
        local source = windowlist.getDropNode();
        if source then
          --[[ newly created entry, set the default number of combatants to one ]]
          number.setValue(1);
          --[[ copy across any complex attributes here ]]
          if source.getChild("fof") then
            friendfoe.setState(source.getChild("fof").getValue());
          else
            friendfoe.setState("neutral");
          end
          --[[ abilities ]]
          if source.getChild("abilities") then
            local abilities = getDatabaseNode().createChild("abilities");
            for k,node in pairs(source.getChild("abilities").getChildren()) do
              abilities.createChild(k,"number").setValue(node.getValue());
            end
          end
          --[[ health and willpower ]]
          if source.getChild("health") then
            local node = getDatabaseNode().createChild("health");
            node.createChild("dots","number").setValue(source.createChild("health.dots","number").getValue());
            node.createChild("bashing","number").setValue(source.createChild("health.bashing","number").getValue());
            node.createChild("lethal","number").setValue(source.createChild("health.lethal","number").getValue());
            node.createChild("aggrevated","number").setValue(source.createChild("health.aggrevated","number").getValue());
          end
          if source.getChild("willpower") then
            local node = getDatabaseNode().createChild("willpower");
            node.createChild("dots","number").setValue(source.createChild("willpower.dots","number").getValue());
            node.createChild("spent","number").setValue(source.createChild("willpower.spent","number").getValue());
          end
          --[[ merits ]]
          if source.getChild("merits") then
            local merits = getDatabaseNode().createChild("merits");
            for k,node in pairs(source.getChild("merits").getChildren()) do
              local merit = merits.createChild(k);
              merit.createChild("dots","number").setValue(node.createChild("dots","number").getValue());
              merit.createChild("name","string").setValue(node.createChild("name","string").getValue());
            end
          end
          --[[ skills ]]
          if source.getChild("skills") then
            local skills = getDatabaseNode().createChild("skills");
            for k,node in pairs(source.getChild("skills").getChildren()) do
              local skill = skills.createChild(k);
              skill.createChild("name","string").setValue(node.createChild("name","string").getValue());
              skill.createChild("rank","number").setValue(node.createChild("rank","number").getValue());
              skill.createChild("specialties","string").setValue(node.createChild("specialties","string").getValue());
            end
          end
          --[[ weapons ]]
          if source.getChild("weapons") then
            local weapons = getDatabaseNode().createChild("weapons");
            for k,node in pairs(source.getChild("weapons").getChildren()) do
              local weapon = weapons.createChild(k);
              weapon.createChild("damage","number").setValue(node.createChild("damage","number").getValue());
              weapon.createChild("name","string").setValue(node.createChild("name","string").getValue());
              weapon.createChild("range.long","number").setValue(node.createChild("range.long","number").getValue());
              weapon.createChild("range.medium","number").setValue(node.createChild("range.medium","number").getValue());
              weapon.createChild("range.short","number").setValue(node.createChild("range.short","number").getValue());
            end
          end
        end
      end
    </script>
    <sheetdata>
      <!-- hidden field -->
      <stringfield name="fof">
        <bounds>0,0,0,0</bounds>
        <invisible/>
        <static/>
      </stringfield>
      <!-- Basics -->
      <tokenfield name="token">
        <bounds>0,1,23,23</bounds>
        <empty>indicator_emptytoken</empty>
      </tokenfield>
      <windowreferencecontrol name="open">
        <anchored>
          <right>
            <anchor>right</anchor>
          </right>
          <top>
            <anchor>top</anchor>
            <offset>3</offset>
          </top>
          <size>
            <width>20</width>
            <height>20</height>
          </size>
        </anchored>
        <icon>
          <normal>button_openwindow</normal>
        </icon>
        <class>npc</class>
      </windowreferencecontrol>
      <genericcontrol name="friendfoe">
        <anchored>
          <to>open</to>
          <position>lefthigh</position>
          <offset>2,-1</offset>
          <size>
            <width>20</width>
            <height>20</height>
          </size>
        </anchored>
        <icon>indicator_ctffempty</icon>
        <stateicons>
          <friend>indicator_ctfffriend</friend>
          <neutral>indicator_ctffneutral</neutral>
          <foe>indicator_ctfffoe</foe>
        </stateicons>
        <script>
          function onDrop(x, y, draginfo)
            if draginfo.isType("combattrackerff") then
              state = draginfo.getStringData();
              window.fof.setValue(state);
              setIcon(stateicons[1][state][1]);
            end
          end
          
          function onClickDown(...)
            return true;
          end
          
          function onClickRelease(...)
            local s = getState();
            if s=="friend" then
              setState("neutral");
            elseif s=="neutral" then
              setState("foe");
            else
              setState("friend");
            end
          end
          
          function onInit()
            local state = window.fof.getValue();
            if stateicons[1][state] then
              setIcon(stateicons[1][state][1]);
            end
          end

          function setState(s)
            state = s;
            window.fof.setValue(state);
            if stateicons[1][state] then
              setIcon(stateicons[1][state][1]);
            else
              setIcon(icon[1]);
            end
          end
          
          function getState()
            return window.fof.getValue();
          end
        </script>
      </genericcontrol>
      <NumberField name="number">
        <anchored>
          <to>friendfoe</to>
          <position>lefthigh</position>
          <offset>4,-1</offset>
          <size>
            <width>34</width>
            <height>22</height>
          </size>
        </anchored>
        <hideonvalue>0</hideonvalue>
        <font>sheetnumbersmall</font>
        <frame>
          <name>bonus</name>
          <offset>2,2,2,1</offset>
        </frame>
        <keyeditframe>
          <name>sheetfocus</name>
          <offset>2,2,2,2</offset>
        </keyeditframe>
      </NumberField>
      <linkstringfield name="name">
        <anchored>
          <left>
            <parent>token</parent>
            <anchor>right</anchor>
            <offset>1</offset>
          </left>
          <right>
            <parent>number</parent>
            <anchor>left</anchor>
            <offset>-2</offset>
          </right>
          <top>
            <anchor>top</anchor>
            <offset>4</offset>
          </top>
          <size>
            <height>20</height>
          </size>
        </anchored>
        <empty>&#171; New Personality &#187;</empty>
        <selectioncolor>#90ffffff</selectioncolor>
        <font>sheettext</font>
        <linktarget>open</linktarget>
      </linkstringfield>
    </sheetdata>
  </windowclass>

</root>
